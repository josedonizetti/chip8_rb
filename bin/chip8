#!/usr/bin/env ruby
require 'gosu'
require 'texplay'
require 'chip8'

class GameWindow < Gosu::Window
  def initialize
    super 640, 320, false, 1
    self.caption = "chip8"

    @img = TexPlay.create_image(self, 640, 320, :color => Gosu::Color::BLUE)
  end

  def load(filename)
    program = File.open(filename, "rb") {|file| file.read }.unpack("C*")
    @vm = Chip8::VM.new(program)
  end

  def update
    y = 0
    @vm.display.each do |line|
      x = 0
      line.each do |column|
        if column == 1
          @img.rect x,y, (x+10), (y+10), :color => :yellow, :fill => true
        end
        x += 10
      end
      y += 10
    end
  end

  def draw
    @img.draw 0, 0,1
  end

  def button_down(id)
    if id == 36
      byte1 = @vm.memory[@vm.pc]
      byte2 = @vm.memory[(@vm.pc + 1)]
      puts Opcode.new(byte1, byte2).parse
      @vm.step
    end

    if id == 15
      puts @vm.registers
    end

    if id == 46
      puts @vm.memory.inspect
    end

    if id == 34
      puts @vm.i.inspect
    end

    if id == 2
      @vm.display.each do |line|
        puts line.join(",")
      end
    end
  end

  def button_up(id)
  end
end

window = GameWindow.new
window.load ARGV[0]
window.show
